<!--
***********************************************************************************************
Microsoft.Windows.UI.Xaml.Common.targets

WARNING:  DO NOT MODIFY this file unless you are knowledgeable about MSBuild and have
          created a backup copy.  Incorrect changes to this file will make it
          impossible to load or build your projects from the command-line or the IDE.

Copyright (C) Microsoft Corporation. All rights reserved.
***********************************************************************************************
-->

<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <UsingTask TaskName="PreparePRIConfigFile" TaskFactory="CodeTaskFactory" AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.Core.dll">
    <ParameterGroup>
      <ConfigPRIFileName ParameterType="System.String" Required="false" />
    </ParameterGroup>
    <Task>
      <Reference Include="System.Xml" />
      <Reference Include="System.Xml.Linq" />
      <Using Namespace="System.Collections.Generic" />
      <Using Namespace="System.IO" />
      <Using Namespace="System.Linq" />
      <Using Namespace="System.Text" />
      <Using Namespace="System.Xml" />
      <Code Type="Fragment" Language="cs">
        <![CDATA[
            string xpath = "resources/packaging";

            if (ConfigPRIFileName != null)
            {
                XmlDocument doc = new XmlDocument();
                doc.Load(ConfigPRIFileName);
                XmlNodeList nodes = doc.SelectNodes(xpath);
                if (nodes.Count > 0)
                {
                    for (int i = nodes.Count - 1; i >= 0; i--)
                    {
                        nodes[i].ParentNode.RemoveChild(nodes[i]);
                    }
                    doc.Save(ConfigPRIFileName);
                }
            }]]>
      </Code>
    </Task>
  </UsingTask>

  <Target Name="GeneratePRIFileForUnpackagedApps" AfterTargets="AfterBuild" Condition="@(AppxManifest)==''">
    <PropertyGroup>
      <PRILanguages>x-generate</PRILanguages>
      <WindowsSdkPath Condition="'$(WindowsSdkPath)'==''">$(MSBuildProgramFiles32)\Windows Kits\10\</WindowsSdkPath>
      <_WindowsSdkPathTools Condition="'$(_WindowsSdkPathTools)'==''">$(WindowsSdkPath)bin\$(_TargetPlatformVersion)\x86\</_WindowsSdkPathTools>
      <MakePRIPath>$(_WindowsSdkPathTools)MakePri.exe</MakePRIPath>
      <ConfigPRIFile>.\$(IntermediateOutputPath)config.xml</ConfigPRIFile>
      <OutputPRIFolder>$(TargetDir)resources.pri</OutputPRIFolder>
      <ProjectRootPRI>$(TargetDir).</ProjectRootPRI>
    </PropertyGroup>

    <!-- Create the config PRI File -->
    <Exec
      Command="&quot;$(MakePRIPath)&quot; createconfig /cf &quot;$(ConfigPRIFile)&quot; /dq $(PRILanguages) /pv 10.0.0 /o"
      WorkingDirectory="$(MSBuildProjectDirectory)" />

    <!-- Remove the packaging section from the PRI Confif file so there is just PRI for everything -->
    <PreparePRIConfigFile ConfigPRIFileName="$(ConfigPRIFile)" />

    <!-- Create the resources.PRI file -->
    <Exec
      Command="&quot;$(MakePRIPath)&quot; new /o /pr &quot;$(ProjectRootPRI)&quot; /cf &quot;$(ConfigPRIFile)&quot; /of &quot;$(OutputPRIFolder)&quot; "
      WorkingDirectory="$(MSBuildProjectDirectory)"/>
  </Target>

</Project>
